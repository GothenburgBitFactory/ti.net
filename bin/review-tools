#!/usr/bin/env bash

function get_added_urls()
{
  git log -p \
      ${LAST_REVIEW_TIMESTAMP+"--since=${LAST_REVIEW_TIMESTAMP}"} \
      --full-diff \
      "${TOOLS_DATA_JSON}" \
       | grep -E "^\+\s+\"url\"" \
       | sed -e "s|.*\"url\": \"\(.*\)\"|\1|" \
       | sort -u
}

function update_review_timestamp()
{
  echo "LAST_REVIEW_TIMESTAMP=$( git log -1 --format=%cd --date=short )" > "${REPO_ROOT}/.review-timestamp"
}

REPO_ROOT="$( git rev-parse --show-toplevel )"
[[ -e "${REPO_ROOT}/.review-timestamp" ]] && source "${REPO_ROOT}/.review-timestamp"
TOOLS_DATA_JSON="${REPO_ROOT}/static/tools-data.json"

declare -a URLS
readarray -t URLS < <( get_added_urls )

if [[ "${#URLS[@]}" -eq 0 ]] ; then
  echo "No new URLs found to review!"
  update_review_timestamp
  exit 0
fi

echo "Reviewing ${#URLS[@]} URLs${LAST_REVIEW_TIMESTAMP+", added since ${LAST_REVIEW_TIMESTAMP}"}..."

declare -a TOOLS_BLACKLIST

for url in "${URLS[@]}" ; do
  open -g "${url}"

  read -r -p "Blacklist ${url}? (y/N): " confirm

  if [[ ! ("${confirm}" =~ [yY]) ]] ; then
    continue
  fi

  read -r -p "Specify reason: because it ... " reason

  TOOLS_BLACKLIST+=( "\"${url}\": \"${reason}\"" )
done

if [[ "${#TOOLS_BLACKLIST[@]}" -ne 0 ]] ; then
  echo "Here are ${#TOOLS_BLACKLIST[@]} entries to be added to 'blacklist.json':"
  for entry in "${TOOLS_BLACKLIST[@]}" ; do
    echo "${entry}"
  done
else
  echo "No new entries to be added to 'blacklist.json'!"
fi

update_review_timestamp
